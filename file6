import org.hibernate.Session;
import org.hibernate.SessionFactory;
import org.hibernate.Transaction;
import org.hibernate.cfg.Configuration;
import javax.persistence.*;
import java.util.List;
import java.util.Properties;
import org.springframework.context.annotation.*;
import org.springframework.stereotype.Repository;
import org.springframework.stereotype.Service;
import org.springframework.transaction.annotation.EnableTransactionManagement;
import org.springframework.transaction.annotation.Transactional;

/**
 * üéØ Library Management System
 * Spring + Hibernate single-file demo project.
 * Demonstrates CRUD + Transaction management for issuing/returning books.
 */
public class LibraryManagementApp {

    // ===============================
    // ENTITY: Book
    // ===============================
    @Entity
    @Table(name = "books")
    public static class Book {
        @Id
        @GeneratedValue(strategy = GenerationType.IDENTITY)
        private int id;

        @Column(nullable = false)
        private String title;

        @Column(nullable = false)
        private String author;

        @Column(nullable = false)
        private boolean available;

        public Book() {}

        public Book(String title, String author, boolean available) {
            this.title = title;
            this.author = author;
            this.available = available;
        }

        public int getId() { return id; }
        public String getTitle() { return title; }
        public String getAuthor() { return author; }
        public boolean isAvailable() { return available; }

        public void setAvailable(boolean available) { this.available = available; }

        @Override
        public String toString() {
            return "Book [id=" + id + ", title=" + title + ", author=" + author + ", available=" + available + "]";
        }
    }

    // ===============================
    // DAO Layer
    // ===============================
    @Repository
    public static class BookDAO {
        private final SessionFactory sessionFactory;

        public BookDAO(SessionFactory sessionFactory) {
            this.sessionFactory = sessionFactory;
        }

        public void save(Book book) {
            sessionFactory.getCurrentSession().save(book);
        }

        public Book getById(int id) {
            return sessionFactory.getCurrentSession().get(Book.class, id);
        }

        public List<Book> getAll() {
            return sessionFactory.getCurrentSession()
                    .createQuery("from LibraryManagementApp$Book", Book.class)
                    .list();
        }

        public void update(Book book) {
            sessionFactory.getCurrentSession().update(book);
        }

        public void delete(Book book) {
            sessionFactory.getCurrentSession().delete(book);
        }
    }

    // ===============================
    // SERVICE Layer
    // ===============================
    @Service
    public static class LibraryService {
        private final BookDAO dao;

        public LibraryService(BookDAO dao) {
            this.dao = dao;
        }

        @Transactional
        public void addBook(String title, String author) {
            Book b = new Book(title, author, true);
            dao.save(b);
            System.out.println("üìö Book added: " + b);
        }

        @Transactional(readOnly = true)
        public void listBooks() {
            System.out.println("\nüìñ Library Books:");
            dao.getAll().forEach(System.out::println);
        }

        @Transactional
        public void issueBook(int id) {
            Book b = dao.getById(id);
            if (b == null) throw new RuntimeException("Book not found!");
            if (!b.isAvailable()) throw new RuntimeException("Book already issued!");
            b.setAvailable(false);
            dao.update(b);
            System.out.println("‚úÖ Issued: " + b.getTitle());
        }

        @Transactional
        public void returnBook(int id) {
            Book b = dao.getById(id);
            if (b == null) throw new RuntimeException("Book not found!");
            if (b.isAvailable()) throw new RuntimeException("Book was not issued!");
            b.setAvailable(true);
            dao.update(b);
            System.out.println("‚Ü©Ô∏è Returned: " + b.getTitle());
        }

        @Transactional
        public void deleteBook(int id) {
            Book b = dao.getById(id);
            if (b != null) {
                dao.delete(b);
                System.out.println("üóëÔ∏è Deleted book: " + b.getTitle());
            } else {
                System.out.println("‚ùå Book not found.");
            }
        }
    }

    // ===============================
    // SPRING CONFIGURATION
    // ===============================
    @Configuration
    @EnableTransactionManagement
    @ComponentScan(basePackageClasses = LibraryManagementApp.class)
    public static class AppConfig {

        @Bean
        public SessionFactory sessionFactory() {
            Properties props = new Properties();
            props.put("hibernate.connection.driver_class", "com.mysql.cj.jdbc.Driver");
            props.put("hibernate.connection.url", "jdbc:mysql://localhost:3306/librarydb");
            props.put("hibernate.connection.username", "root");
            props.put("hibernate.connection.password", "root");
            props.put("hibernate.dialect", "org.hibernate.dialect.MySQL8Dialect");
            props.put("hibernate.hbm2ddl.auto", "update");
            props.put("hibernate.show_sql", "true");

            Configuration cfg = new Configuration();
            cfg.addProperties(props);
            cfg.addAnnotatedClass(Book.class);
            return cfg.buildSessionFactory();
        }

        @Bean
        public org.springframework.orm.hibernate5.HibernateTransactionManager transactionManager(SessionFactory sf) {
            return new org.springframework.orm.hibernate5.HibernateTransactionManager(sf);
        }

        @Bean
        public BookDAO bookDAO(SessionFactory sf) {
            return new BookDAO(sf);
        }

        @Bean
        public LibraryService libraryService(BookDAO dao) {
            return new LibraryService(dao);
        }
    }

    // ===============================
    // MAIN APPLICATION
    // ===============================
    public static void main(String[] args) {
        AnnotationConfigApplicationContext context =
                new AnnotationConfigApplicationContext(AppConfig.class);

        LibraryService service = context.getBean(LibraryService.class);

        System.out.println("\n=== üìö LIBRARY MANAGEMENT SYSTEM ===");

        // Add books
        service.addBook("The Great Gatsby", "F. Scott Fitzgerald");
        service.addBook("1984", "George Orwell");
        service.addBook("Clean Code", "Robert C. Martin");

        service.listBooks();

        // Issue a book
        try {
            service.issueBook(2);
        } catch (Exception e) {
            System.err.println("‚ùå Error: " + e.getMessage());
        }

        // Return a book
        try {
            service.returnBook(2);
        } catch (Exception e) {
            System.err.println("‚ùå Error: " + e.getMessage());
        }

        // Delete a book
        service.deleteBook(1);

        service.listBooks();

        context.close();
        System.out.println("\n‚úÖ Library Management System Completed Successfully!");
    }
}
